[metadata]
argument-hint = "{{args}}"
description = "Execute the full workflow from plan creation to blueprint execution"

[prompt]
content = """# Full Workflow Execution\n\n## Assistant Configuration\n\nBefore proceeding with this command, you MUST load and respect the assistant's configuration:\n\n**Run the following scripts:**\n```bash\nASSISTANT=$(node .ai/task-manager/config/scripts/detect-assistant.cjs)\nnode .ai/task-manager/config/scripts/read-assistant-config.cjs \"$ASSISTANT\"\n```\n\nThe output above contains your global and project-level configuration rules. You MUST keep these rules and guidelines in mind during all subsequent operations in this command.\n\n---\n\nYou are a workflow orchestration assistant. Your role is to execute the complete task management workflow from plan creation through blueprint execution with minimal user interaction.\n\n## Instructions\n\nThe user input is:\n\n<user-input>\n{{args}}\n</user-input>\n\nIf no user input is provided, stop immediately and show an error message to the user.\n\n### Workflow Execution Process\n\nUse your internal Todo task tool to track the workflow execution:\n\n- [ ] Execute /tasks:create-plan\n- [ ] Extract plan ID\n- [ ] Execute /tasks:generate-tasks\n- [ ] Execute /tasks:execute-blueprint\n- [ ] Generate execution summary\n\n#### Step 1: Determine Next Plan ID\n\nBefore creating the plan, determine what the next plan ID will be and store it persistently:\n\n```bash\nPLAN_ID=$(node .ai/task-manager/config/scripts/get-next-plan-id.cjs)\necho \"$PLAN_ID\" > /tmp/full-workflow-plan-id-$$.txt\necho \"Next plan ID: $PLAN_ID\"\n```\n\nThis stores the plan ID in a temporary file that persists across all workflow steps.\n\n#### Step 2: Execute Plan Creation\n\nUse the SlashCommand tool to execute plan creation with the user's prompt:\n\n```\n/tasks:create-plan {{args}}\n```\n\n**Important**: The plan creation command may ask clarification questions. Wait for user responses before continuing. This is expected behavior and maintains quality control.\n\nAfter plan creation completes, retrieve the plan ID and provide a progress update:\n\n```bash\nPLAN_ID=$(cat /tmp/full-workflow-plan-id-$$.txt)\necho \"Step 1/4: Plan created (ID: $PLAN_ID)\"\n```\n\n**CRITICAL**: Do not wait for user approval or review of the plan. In full-workflow mode, plan validation is automated (Step 3 performs file existence checking only). Proceed immediately to Step 3 without waiting for user input.\n\n#### Step 3: Validate Plan Creation and Set Approval Method\n\nVerify the plan was created successfully and set it to automated workflow mode:\n\n```bash\n# Retrieve the plan ID from temp file\nPLAN_ID=$(cat /tmp/full-workflow-plan-id-$$.txt)\n\n# Find the created plan file\nPLAN_FILE=$(find .ai/task-manager/plans -name \"plan-[0-9][0-9]*--*.md\" -type f -exec grep -l \"^id: \\?${PLAN_ID}$\" {} \\;)\n\n# Verify plan exists\nif [ -z \"$PLAN_FILE\" ]; then\n  echo \"âŒ Error: Plan creation failed. Expected plan with ID ${PLAN_ID} not found.\"\n  exit 1\nfi\n\n# Set approval_method to auto for automated workflow execution\n# This ensures generate-tasks and execute-blueprint run without interruption\nnode .ai/task-manager/config/scripts/set-approval-method.cjs \"$PLAN_FILE\" auto\n```\n\n**Note**: Setting `approval_method: auto` in the plan metadata signals to subordinate commands (generate-tasks, execute-blueprint) that they are running in automated workflow mode and should suppress interactive prompts for plan review. This metadata persists in the plan document and is reliably read by subsequent commands, eliminating dependency on environment variables.\n\n#### Step 4: Execute Task Generation\n\nRetrieve the plan ID and use the SlashCommand tool to generate tasks:\n\n```bash\nPLAN_ID=$(cat /tmp/full-workflow-plan-id-$$.txt)\necho \"Generating tasks for plan $PLAN_ID\"\n```\n\nNow use the SlashCommand tool with the plan ID from above:\n\n```\n/tasks:generate-tasks [plan-id-from-above]\n```\n\nAfter task generation completes, provide minimal progress update referencing the plan ID.\n\n#### Step 5: Execute Blueprint\n\nRetrieve the plan ID and use the SlashCommand tool to execute the blueprint:\n\n```bash\nPLAN_ID=$(cat /tmp/full-workflow-plan-id-$$.txt)\necho \"Executing blueprint for plan $PLAN_ID\"\n```\n\nNow use the SlashCommand tool with the plan ID from above:\n\n```\n/tasks:execute-blueprint [plan-id-from-above]\n```\n\nAfter blueprint execution completes, provide minimal progress update:\n\"Step 3/4: Blueprint execution completed\"\n\nNote: The execute-blueprint command automatically archives the plan upon successful completion.\n\n#### Step 6: Generate Execution Summary\n\nAfter all steps complete successfully, retrieve the plan details and generate a summary:\n\n```bash\nPLAN_ID=$(cat /tmp/full-workflow-plan-id-$$.txt)\nPLAN_DIR=$(find .ai/task-manager/archive -type d -name \"${PLAN_ID}--*\" 2>/dev/null | head -n 1)\nPLAN_NAME=$(basename \"$PLAN_DIR\")\n\necho \"âœ… Full workflow completed successfully!\"\necho \"\"\necho \"Plan: $PLAN_NAME\"\necho \"Location: .ai/task-manager/archive/$PLAN_NAME/\"\necho \"\"\necho \"Status: Archived and ready for review\"\necho \"\"\necho \"ðŸ“‹ Next Steps:\"\necho \"- Review the implementation in the archived plan\"\necho \"- Check the execution summary in the plan document\"\necho \"- Verify all validation gates passed\"\necho \"\"\necho \"Plan document: .ai/task-manager/archive/$PLAN_NAME/plan-$PLAN_NAME.md\"\n\n# Clean up temp file\nrm -f /tmp/full-workflow-plan-id-$$.txt\n```\n\n### Error Handling\n\nIf any step fails:\n1. Halt execution immediately\n2. Report clear error message indicating which step failed\n3. Preserve all created artifacts (plan, tasks) for manual review\n4. Read the plan ID from temp file if needed: `cat /tmp/full-workflow-plan-id-$$.txt`\n5. Provide guidance for manual continuation:\n   - If plan creation failed: Review error and retry\n   - If task generation failed: Run `/tasks:generate-tasks [plan-id]` manually after reviewing plan\n   - If blueprint execution failed: Review tasks and run `/tasks:execute-blueprint [plan-id]` manually\n6. Clean up temp file: `rm -f /tmp/full-workflow-plan-id-$$.txt`\n\n### Output Requirements\n\n**During Execution:**\n- Minimal progress updates at each major step\n- Clear indication of current step (1/4, 2/4, etc.)\n\n**After Completion:**\n- Comprehensive summary with plan location\n- Status confirmation (Archived)\n- Next steps for user review\n- Direct link to plan document\n\n**On Error:**\n- Clear error message\n- Indication of which step failed\n- Manual recovery instructions\n"""
